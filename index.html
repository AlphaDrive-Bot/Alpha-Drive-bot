<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AlphaDrive Bot</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet" />
  <style>
    /* [העיצוב נשמר כפי שהיה] */
    /* ... כל ה-CSS נשאר ללא שינוי ... */
  </style>
</head>
<body>
  <div class="title">שוחח עם הסוכן הדיגיטלי</div>
  <div class="subtitle"><span style="color: #fff;">Alpha</span><span style="color: #4fc3f7;">-Drive</span></div>

  <div style="margin-bottom: 10px;">
    <button onclick="startRecording()" style="background-color: #4caf50; color: #fff; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-size: 16px;">התחל שיחה</button>
  </div>

  <div id="response"></div>
  <div id="speaking-indicator" class="speaking-indicator" style="display: none;">
    <span></span><span></span><span></span><span></span><span></span>
  </div>
  <div id="recording-indicator" style="display: none; margin-bottom: 12px;">🎙️ אתה מדבר...</div>
  <div id="recording-visualizer" style="display: none;">
    <span></span><span></span><span></span><span></span><span></span>
  </div>
  <button id="stopConversation" style="position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background-color: #f44336; color: #fff; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 14px;">עצור שיחה</button>

  <div class="chat-container">
    <button class="mic-button" aria-label="הקלט קול" id="micBtn">
      <svg xmlns="http://www.w3.org/2000/svg" height="22" width="22" viewBox="0 0 24 24">
        <path d="M12 14q-1.25 0-2.125-.875T9 11V5q0-1.25.875-2.125T12 2q1.25 0 2.125.875T15 5v6q0 1.25-.875 2.125T12 14Zm-1 7v-3.1q-2.9-.35-4.95-2.525Q4 13.2 4 10h2q0 2.5 1.75 4.25T12 16q2.5 0 4.25-1.75T18 10h2q0 3.2-2.05 5.375T13 17.9V21Z"/>
      </svg>
    </button>
    <input type="text" id="userInput" placeholder="הקלד כאן..." />
    <button class="send-button" aria-label="שלח" id="sendBtn">
      <svg xmlns="http://www.w3.org/2000/svg" height="20" width="20" fill="#555">
        <path d="M2 10L18 2l-4 8 4 8z"/>
      </svg>
    </button>
  </div>

  <script>
    const responseDiv = document.getElementById("response");
    const inputEl = document.getElementById("userInput");
    const micButton = document.getElementById("micBtn");
    const sendButton = document.getElementById("sendBtn");
    let mediaRecorder;
    let audioChunks = [];
    let continueConversation = true;

    function showSpeakingIndicator() {
      document.getElementById("speaking-indicator").style.display = "flex";
    }
    function hideSpeakingIndicator() {
      document.getElementById("speaking-indicator").style.display = "none";
    }
    function showRecordingVisualizer() {
      document.getElementById("recording-visualizer").style.display = "flex";
    }
    function hideRecordingVisualizer() {
      document.getElementById("recording-visualizer").style.display = "none";
    }

    async function startRecording() {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];
      document.getElementById("recording-indicator").style.display = "block";
      showRecordingVisualizer();

      mediaRecorder.ondataavailable = event => {
        audioChunks.push(event.data);
      };

      mediaRecorder.onstop = async () => {
        document.getElementById("recording-indicator").style.display = "none";
        hideRecordingVisualizer();
        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        const formData = new FormData();
        formData.append('file', audioBlob, 'recording.webm');
        formData.append('message_type', 'voice');
        formData.append('source', 'mic');

        const thinking = document.createElement("div");
        thinking.id = "thinking";
        thinking.innerHTML = `⏳ הסוכן חושב...<div class="speaking-indicator"><span></span><span></span><span></span><span></span><span></span></div>`;
        responseDiv.appendChild(thinking);
        scrollToBottom();

        try {
          const res = await fetch("https://chaim.app.n8n.cloud/webhook/886eec14-f666-4db2-96f8-5914f21751d0", {
            method: "POST",
            body: formData
          });
          await handleResponse(res);
        } catch (err) {
          thinking.remove();
          responseDiv.innerHTML += `<p>❌ שגיאה בשליחה: ${err.message}</p>`;
        }
      };

      mediaRecorder.start();
      setTimeout(() => {
        if (mediaRecorder && mediaRecorder.state !== "inactive") {
          mediaRecorder.stop();
        }
      }, 5000);
    }

    async function handleResponse(res) {
      const thinking = document.getElementById("thinking");
      if (thinking) thinking.remove();
      const contentType = res.headers.get("Content-Type");

      if (contentType && contentType.includes("audio")) {
        const blob = await res.blob();
        const audioUrl = URL.createObjectURL(blob);
        showSpeakingIndicator();
        const audio = new Audio(audioUrl);
        audio.play();
        audio.onended = () => {
          hideSpeakingIndicator();
          if (continueConversation) startRecording();
        };
        return;
      }

      const raw = await res.text();
      let parsed = null;
      try { parsed = JSON.parse(raw.trim()); } catch (_) { parsed = { text: raw }; }

      if (parsed.text) {
        const botMsg = document.createElement("div");
        botMsg.className = "bubble bot-bubble fade-in";
        botMsg.innerHTML = parsed.text;
        responseDiv.appendChild(botMsg);
      }

      if (parsed.audio_url) {
        const audio = new Audio(parsed.audio_url);
        showSpeakingIndicator();
        audio.play();
        audio.onended = () => {
          hideSpeakingIndicator();
          if (continueConversation) startRecording();
        };
      }

      scrollToBottom();
    }

    function scrollToBottom() {
      setTimeout(() => {
        responseDiv.scrollTop = responseDiv.scrollHeight;
      }, 100);
    }

    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
      }
    }

    document.getElementById("stopConversation").addEventListener("click", () => {
      continueConversation = false;
      document.getElementById("recording-indicator").style.display = "none";
      hideRecordingVisualizer();
      hideSpeakingIndicator();
      alert("השיחה הופסקה. תוכל להפעיל מחדש בלחיצה על המיקרופון.");
    });

    sendButton.addEventListener("click", () => sendToBot());
    inputEl.addEventListener("keydown", function (e) {
      if (e.key === "Enter") sendToBot();
    });

    async function sendToBot(text = null) {
      const input = text || inputEl.value.trim();
      if (!input) return;
      const userMsg = document.createElement("div");
      userMsg.className = "bubble user-bubble fade-in";
      userMsg.innerText = input;
      responseDiv.appendChild(userMsg);
      scrollToBottom();

      const thinking = document.createElement("div");
      thinking.id = "thinking";
      thinking.innerHTML = `⏳ הסוכן חושב...<div class="speaking-indicator"><span></span><span></span><span></span><span></span><span></span></div>`;
      responseDiv.appendChild(thinking);
      inputEl.value = "";

      try {
        const res = await fetch("https://chaim.app.n8n.cloud/webhook/886eec14-f666-4db2-96f8-5914f21751d0", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: input })
        });
        await handleResponse(res);
      } catch (err) {
        thinking.remove();
        responseDiv.innerHTML += `<p>❌ שגיאה בשליחה: ${err.message}</p>`;
      }
    }
  </script>
</body>
</html>
